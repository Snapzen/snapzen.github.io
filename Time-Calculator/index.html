<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="On Duty Calculator | Syn County Sheriffs Department" property="og:title" />
    <meta content="A on duty calculator that makes activity checks easier!" property="og:description" />
    <meta content="https://snapzen.github.io/" property="og:url" />
    <meta content="https://i.gyazo.com/bba9f246cb83c4ec1561964a8359a44c.png" property="og:image" />
    <meta content="#5c5c5c" data-react-helmet="true" name="theme-color" />

    <title>On Duty Calculator | Syn County Sheriffs Department</title>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3" crossorigin="anonymous"></script>
    <link href="../Charge-Calculator/style.css" rel="stylesheet">   
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        textarea#dataInput { width: 100%; height: 200px; }
        .output { margin-top: 20px; }
    </style> 
</head>
<body>
    <div class="container text-center calc-header">
        <div class="row">
            <div class="col">
            </div>
            <div class="col-6">
                <div id="header">
                    <img src="../Charge-Calculator/synlogo.png" width="80">
                    <h1 id="head-title">Duty Time Calculator</h1>
                </div>
            </div>
            <div class="col">
            </div>
        </div>
        <div class="row">
            <p>Paste the log data below:</p>
        </div>
        <div class="row">
            <textarea id="dataInput" placeholder="Paste duty logs here..."></textarea>
            <button class="calc-button btn-danger btn" onclick="calculateDutyTime()">Calculate</button>
        </div>
        <div class="row">
            <div class="output calc-title">
                <h2>Results:</h2>
                <div id="dailyDutyTimes"></div>
                <p id="totalOnDutyTime">Total On Duty Time: </p>
            </div>
        </div>
    </div>
    <script>
        function parseDateTime(entry) {
            // Patterns for various date formats
            const format24hr = /— (\d{4}[-/]\d{2}[-/]\d{2} \d{2}:\d{2})/;  // YYYY-MM-DD or YYYY/MM/DD HH:mm
            const format12hr = /— (\d{2}[-/]\d{2}[-/]\d{4} \d{1,2}:\d{2} (AM|PM))/i;  // MM/DD/YYYY or MM-DD-YYYY hh:mm AM/PM
            const formatDayMonthYear = /— (\d{2})[-/](\d{2})[-/](\d{4}) (\d{1,2}:\d{2} (AM|PM)?)/i;  // DD/MM/YYYY or DD-MM-YYYY hh:mm

            let match = entry.match(format24hr);
            if (match) return new Date(match[1]);  // Parse 24-hour format directly

            match = entry.match(format12hr);
            if (match) return new Date(Date.parse(match[1]));  // Parse 12-hour with AM/PM

            match = entry.match(formatDayMonthYear);  // Match DD/MM/YYYY or DD-MM-YYYY
            if (match) {
                const [_, day, month, year, time] = match;
                return new Date(`${year}-${month}-${day} ${time}`);
            }

            // If no valid date is found, return null
            return null;
        }

        function calculateDutyTime() {
            const data = document.getElementById("dataInput").value;
            const entries = data.split(/(?=On Duty|Off Duty)/g);

            let dailyDutyTimes = {}; // Store duty times per day
            let lastOnDuty = null;
            let totalOnDutyTime = 0;

            const parsedEntries = entries.map(entry => {
                const dateTime = parseDateTime(entry);
                return { entry, dateTime };
            }).filter(e => e.dateTime)
              .sort((a, b) => a.dateTime - b.dateTime);

            parsedEntries.forEach(({ entry, dateTime }) => {
                if (entry.includes("Is on Duty")) {
                    lastOnDuty = dateTime;
                } else if (entry.includes("Is off Duty") && lastOnDuty) {
                    const onDutyTime = dateTime - lastOnDuty;

                    const dutyDate = lastOnDuty.toISOString().split('T')[0];
                    if (!dailyDutyTimes[dutyDate]) dailyDutyTimes[dutyDate] = 0;
                    dailyDutyTimes[dutyDate] += onDutyTime;

                    totalOnDutyTime += onDutyTime;
                    lastOnDuty = null;
                }
            });

            displayResults(dailyDutyTimes, totalOnDutyTime);
        }

        function displayResults(dailyDutyTimes, totalOnDutyTime) {
            const dailyDutyDiv = document.getElementById("dailyDutyTimes");
            dailyDutyDiv.innerHTML = "<h3>Daily On Duty Times:</h3>";

            Object.keys(dailyDutyTimes).forEach(date => {
                const timeString = msToTime(dailyDutyTimes[date]);
                const entry = document.createElement("p");
                entry.textContent = `${date}: ${timeString}`;
                dailyDutyDiv.appendChild(entry);
            });

            document.getElementById("totalOnDutyTime").textContent = 
                `Total On Duty Time: ${msToTime(totalOnDutyTime)}`;
        }

        function msToTime(duration) {
            const minutes = Math.floor((duration / (1000 * 60)) % 60);
            const hours = Math.floor((duration / (1000 * 60 * 60)) % 24);
            const days = Math.floor(duration / (1000 * 60 * 60 * 24));
            return `${days} days, ${hours} hours, ${minutes} minutes`;
        }
    </script>
</body>
</html>

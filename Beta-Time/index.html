<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>On-Duty Time Calculator</title>
</head>
<body>
  <h1>On-Duty Time Calculator</h1>
  <textarea id="inputText" rows="20" cols="100" placeholder="Paste your log here..."></textarea>
  <br>
  <button onclick="calculateOnDutyTime()">Calculate On-Duty Time</button>
  <h2>Total On-Duty Time:</h2>
  <p id="result">0 hours 0 minutes</p>

  <script>
    function parseDate(dateString) {
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(today.getDate() - 1);

      let date, time;

      if (/Today|Idag/i.test(dateString)) {
        time = dateString.replace(/Today|Idag/i, '').trim();
        date = today;
      } else if (/Yesterday|Igår/i.test(dateString)) {
        time = dateString.replace(/Yesterday|Igår/i, '').trim();
        date = yesterday;
      } else if (/\d{4}-\d{2}-\d{2}/.test(dateString)) {
        // Handling YYYY-MM-DD format
        let parts = dateString.split(/,?\s+/);
        let datePart = parts[0].split('-');
        date = new Date(`${datePart[0]}-${datePart[1]}-${datePart[2]}T${parts[1]}`);
        return date;
      } else if (/\d{2}\/\d{2}\/\d{4}/.test(dateString)) {
        // Handling DD/MM/YYYY format
        let parts = dateString.split(/,?\s+/);
        let datePart = parts[0].split('/');
        if (datePart[0].length === 2 && datePart[1].length === 2) {
          // Assuming DD/MM/YYYY
          date = new Date(`${datePart[2]}-${datePart[1]}-${datePart[0]}T${parts[1]}`);
        } else {
          // Assuming MM/DD/YYYY
          date = new Date(dateString);
        }
        return date;
      } else {
        return new Date(dateString); // Fallback for absolute date strings
      }

      const timeMatch = time.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
      if (timeMatch) {
        let hours = parseInt(timeMatch[1], 10);
        const minutes = parseInt(timeMatch[2], 10);
        const period = timeMatch[3] ? timeMatch[3].toUpperCase() : null;

        if (period === "PM" && hours !== 12) hours += 12;
        if (period === "AM" && hours === 12) hours = 0;

        date.setHours(hours, minutes, 0, 0);
        return date;
      }

      console.warn(`Invalid time format: ${time}`);
      return NaN;
    }

    function cleanInput(inputText) {
      const lines = inputText.split('\n').filter(line => {
        return /—\s+|\bIs (on|off) Duty\b/i.test(line.trim());
      });
      return lines.join('\n');
    }

    function calculateOnDutyTime() {
      let inputText = document.getElementById('inputText').value;
      inputText = cleanInput(inputText); // Clean input text
      const lines = inputText.split('\n').filter(line => line.trim() !== ''); // Ignore empty lines

      let totalMinutes = 0;
      let lastOnDutyTime = null;

      const timeRegex = /—\s+(.*)/i;
      const onDutyRegex = /Is on Duty\b/i;
      const offDutyRegex = /Is off Duty\b/i;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const timeMatch = line.match(timeRegex);
        console.log("Line:", line, "| Match:", timeMatch);

        if (timeMatch) {
          const timestamp = parseDate(timeMatch[1].trim());
          console.log("Parsed Timestamp:", timestamp);

          if (onDutyRegex.test(lines[i + 1])) {
            console.log("Matched On Duty:", lines[i + 1]);
            lastOnDutyTime = timestamp;
          } else if (offDutyRegex.test(lines[i + 1]) && lastOnDutyTime) {
            console.log("Matched Off Duty:", lines[i + 1]);
            const diff = (timestamp - lastOnDutyTime) / 60000; // Difference in minutes
            console.log(`Timestamp Difference: ${diff} minutes`);
            totalMinutes += diff;
            lastOnDutyTime = null;
          }
        } else {
          console.warn(`No time found in line: ${line}`);
        }
      }

      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;

      console.log("Total Minutes:", totalMinutes);
      const resultElement = document.getElementById('result');
      if (resultElement) {
        resultElement.textContent = `${hours} hours ${minutes} minutes`;
      } else {
        console.error("Result element not found");
      }
    }
  </script>
</body>
</html>
